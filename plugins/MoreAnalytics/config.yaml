id: MoreAnalytics
label: MoreAnalytics
description: <__trans phrase="Provides more features for Google Analytics.">
author: <__trans phrase="ideaman's Inc.">
author_link: http://www.ideamans.com/
version: 0.4.0
schema_version: 0.11
l10n_class: MT::MoreAnalytics::L10N
system_config_template: config/system.tmpl

settings:
    update_object_stats_freq_min:
        Scope: system
        Default: 180
    cleanup_cache_freq_min:
        Scope: system
        Default: 1440
    cache_size_limit_mb:
        Scope: system
        Default: 100

permissions:
    website.ma_edit_custom_widget:
        group: website_admin
        label: Edit Custom KPI Widget
        order: 3000
        permitted_action:
            ma_edit_custom_widget: 1
    blog.ma_edit_custom_widget:
        group: blog_admin
        label: Edit Custom KPI Widget
        order: 3000
        permitted_action:
            ma_edit_custom_widget: 1
    website.ma_manage_period:
        group: website_admin
        label: Manage Aggregation Period
        order: 3100
        permitted_action:
            ma_list_period: 1
            ma_edit_period: 1
    blog.ma_manage_period:
        group: blog_admin
        label: Manage Aggregation Period
        order: 3100
        permitted_action:
            ma_list_period: 1
            ma_edit_period: 1
    website.ma_playground:
        group: website_admin
        label: Google Analytics API Playground
        order: 3200
        permitted_action:
            ma_playground: 1
    blog.ma_playground:
        group: blog_admin
        label: Google Analytics API Playground
        order: 3200
        permitted_action:
            ma_playground: 1
    system.ma_manage_period:
        group: sys_admin
        label: Manage Aggregation Period
        order: 3100
        permitted_action:
            ma_list_period: 1
            ma_edit_period: 1
    website.administer_blog:
        inherit_from:
            - website.edit_custom_widget
            - website.ma_manage_period
            - website.ma_playground
    blog.administer_blog:
        inherit_from:
            - blog.edit_custom_widget
            - blog.ma_manage_period
            - blog.ma_playground

period_methods:
    yesterday:
        available_for:
            to: 1
        label: Yesterday(The last day)
        order: 100
        summarize: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::summarize_yesterday
        timestamp: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::timestamp_yesterday
        validate: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::validate_free
    today:
        available_for:
            to: 1
        label: Today(The day)
        order: 200
        summarize: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::summarize_today
        timestamp: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::timestamp_today
        validate: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::validate_free
    days_before:
        label: Days before
        order: 300
        template: period_methods/days_before.tmpl
        summarize: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::summarize_days_before
        timestamp: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::timestamp_days_before
        validate: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::validate_days_before
    fixed:
        label: Fixed date
        order: 400
        template: period_methods/fixed.tmpl
        summarize: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::summarize_fixed
        timestamp: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::timestamp_fixed
        validate: $MoreAnalytics::MT::MoreAnalytics::PeriodMethod::Common::validate_fixed

object_types:
    ma_cache: MT::MoreAnalytics::Cache
    ma_object_stat: MT::MoreAnalytics::ObjectStat
    ma_period: MT::MoreAnalytics::Period
    website:
        ma_custom_widget: text meta
    blog:
        ma_custom_widget: text meta
    author:
        ma_custom_widget: text meta

listing_screens:
    ma_period:
        object_label: Aggregation Period
        primary: title
        default_sort_key: title
        permission:
            permit_action: ma_list_period
            inherit: 0

list_properties:
    entry: $MoreAnalytics::MT::MoreAnalytics::App::CMS::entry_list_props
    page: $MoreAnalytics::MT::MoreAnalytics::App::CMS::entry_list_props
    ma_period: $MoreAnalytics::MT::MoreAnalytics::Period::list_props

callbacks:
    post_init: $MoreAnalytics::MT::MoreAnalytics::on_post_init

applications:
    cms:
        methods:
            ma_playground: $MoreAnalytics::MT::MoreAnalytics::CMS::Playground::index
            ma_playground_query: $MoreAnalytics::MT::MoreAnalytics::CMS::Playground::query
            ma_preview: $MoreAnalytics::MT::MoreAnalytics::App::CMS::preview
            ma_profiles: $MoreAnalytics::MT::MoreAnalytics::App::CMS::profiles
            ma_custom_widget: $MoreAnalytics::MT::MoreAnalytics::CMS::Widget::custom_widget_ajax
            ma_drop_all_caches: $MoreAnalytics::MT::MoreAnalytics::App::CMS::drop_all_caches
        callbacks:
            cms_edit.ma_period: $MoreAnalytics::MT::MoreAnalytics::CMS::Period::on_edit_period
            cms_save_filter.ma_period: $MoreAnalytics::MT::MoreAnalytics::CMS::Period::on_save_filter_period
            cms_pre_save.ma_period: $MoreAnalytics::MT::MoreAnalytics::CMS::Period::on_pre_save_period
            template_param.list_common: $MoreAnalytics::MT::MoreAnalytics::App::CMS::on_template_param_list_common
            cms_pre_load_filtered_list.entry: $MoreAnalytics::MT::MoreAnalytics::App::CMS::on_pre_load_filtered_list_entry
            cms_pre_load_filtered_list.page: $MoreAnalytics::MT::MoreAnalytics::App::CMS::on_pre_load_filtered_list_entry
        content_actions:
            ma_period:
                new_peiod:
                    mode: edit
                    args:
                        _type: ma_period
                    class: icon-create
                    label: New Period
                    order: 100
        menus:
            ga:
                label: Google Analytics
                order: 5000
            ga:playground:
                label: API Playground
                order: 100
                mode: ma_playground
                permit_action: ma_playground
                view:
                    - blog
                    - website
            ga:period:
                label: Aggregation Periods
                order: 200
                mode: list
                permit_action: ma_list_period
                view:
                    - system
                    - website
                    - blog
                args:
                    _type: ma_period

widgets:
    ma_custom_main_widget:
        order:    1
        label:    Custom Widget
        plugin:   $MoreAnalytics
        template: widget/custom_main_widget.tmpl
        set: main
        singular: 1
        code:     $MoreAnalytics::MT::MoreAnalytics::CMS::Widget::custom_main_widget
        view:
            - website
            - blog
            - user

tags:
    block:
        GAIfReady?: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAIfReady
        GAProfiles: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAProfiles
        GAReport: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAReport
        GAReportHeader?: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAReportHeader
        GAReportFooter?: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAReportFooter
        GAGuessObject: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAGuessObject
        GAIfObjectType?: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAIfObjectType
        Entries: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_Entries
        Pages: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_Entries
    function:
        GAProfile: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAProfile
        GAValue: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAValue
        GAReportBreak: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAReportBreak
        GAEntryStat: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAEntryStat
        GAPageStat: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAPageStat
        GACategoryStat: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GACategoryStat
        GAFolderStat: $MoreAnalytics::MT::MoreAnalytics::Tags::hdlr_GAFolderStat
    filters:
        Entries:
            ga:sort_by:
                handler: $MoreAnalytics::MT::MoreAnalytics::Tags::entries_filter

tasks:
    ma_update_object_stats:
        label: MoreAnalytics Updates Object Stats
        code: $MoreAnalytics::MT::MoreAnalytics::Tasks::update_object_stats
        frequency: |
            sub {
                my %config;
                MT->component('MoreAnalytics')->load_config(\%config, 'system');
                $config{update_object_stats_freq_min} * 60;
            }
    ma_cleanup_cache:
        label: MoreAnalytics Cleanup Cache
        code: $MoreAnalytics::MT::MoreAnalytics::Tasks::cleanup_cache
        frequency: |
            sub {
                my %config;
                MT->component('MoreAnalytics')->load_config(\%config, 'system');
                $config{cleanup_cache_freq_min} * 60;
            }

stats_providers:
    MoreAnalytics:
        provider: MT::MoreAnalytics::Provider
